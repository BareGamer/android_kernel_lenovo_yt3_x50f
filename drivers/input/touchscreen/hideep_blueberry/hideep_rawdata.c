
#include "hideep.h"

const s16 rawdata_min[HIDEEP_RX_COUNT*HIDEEP_TX_COUNT] = {
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,   0,0
};
const s16 rawdata_max[HIDEEP_RX_COUNT*HIDEEP_TX_COUNT] = {
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000
};
const s16 diffdata_min[HIDEEP_RX_COUNT*HIDEEP_TX_COUNT] = {
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,   -30000,-30000
};
const s16 diffdata_max[HIDEEP_RX_COUNT*HIDEEP_TX_COUNT] = {
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,   30000,30000
};
const s16 z_rawdata_min[HIDEEP_TX_COUNT] = {
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,0,
	0,0,0,0,0,0,0,0,  0,0,0,0,0,0,0,
	};
const s16 z_rawdata_max[HIDEEP_TX_COUNT] = {
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000
};
const s16 z_diffdata_min[HIDEEP_TX_COUNT] = {
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,
	-30000,-30000,-30000,-30000,-30000,-30000,-30000,-30000,  -30000,-30000,-30000,-30000,-30000,-30000,-30000
};
const s16 z_diffdata_max[HIDEEP_TX_COUNT] = {
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000,30000,
	30000,30000,30000,30000,30000,30000,30000,30000,  30000,30000,30000,30000,30000,30000,30000
};

int hideep_get_image_by_cmd(u16 command, u8 flag)
{
	struct hideep_data *ts   = private_ts;
	struct hideep_debug_dev *dev = &ts->debug_dev;
	int retry;
	int time_out;
	int ret=0;

	dbg_fun("hideep_get_image enter");
	for(retry = 0;retry <1;retry ++){
		ts->pdata->reset();
		mdelay(HIDEEP_RESET_DELAY+100);
		ret = hideep_i2c_write(ts->client, command, 1, (u8*)&flag);
		if(ret < 0)
			goto hideep_get_image_command_err;
		time_out = 0;
		do{
			mdelay(HIDEEP_IMAGE_DELAY+200);
			//hideep_get_image(ts);
			ret = hideep_i2c_read(ts->client, 0x1008, (HIDEEP_TX_COUNT*HIDEEP_RX_COUNT)*2, (unsigned char *)dev->im_buff);
			//ret = hideep_i2c_read(ts->client, 0x1000, (HIDEEP_TX_COUNT*HIDEEP_RX_COUNT)*2+8, (unsigned char *)dev->im_buff);
			dbg_fun("time count %d, dev->im_buff[0] = 0x%02x\n",time_out,dev->im_buff[0]);
			//if(dev->im_buff[0]=='G')
			//	break;
			time_out++;
		}while(time_out<1);
	}
	dbg_fun("get correct image");
	return 0;
hideep_get_image_command_err:
	dbg_err("send command error");
	return -1;
}

#define calculate_data_init(offset,pmin,pmax)\
do{\
	ps16 = (s16*)dev->im_buff;\
	min = 0xffff;\
	max = 0x0;\
	sum = 0;\
	ps32 = (s32*)(info->buff+offset);\
	fail_node = 0;\
	min_ps16 = pmin;\
	max_ps16 = pmax;\
}while(0)

#define calculate_data_result(p1,p2,min,max,sum)\
do{\
	*p1 = *p2;\
	if((*p2>*max_##p2)||(*p2<*min_##p2)){\
		dbg_fun("data = %d, max = %d, min = %d", *p2, *max_##p2, *min_##p2);\
		fail_node++;\
	}\
	min_##p2++;\
	max_##p2++;\
	min = *p2<min?*p2:min;\
	max = *p2>max?*p2:max;\
	sum+= *p2;\
	p1++;\
	p2++;\
}while(0)

#define HIDEEP_DEBUG_RAWDATA_LOG

int hideep_get_rawdata(struct rawdata_info *info)
{
	int ret = 0;
	s16 *ps16;
	const s16 * min_ps16;
	const s16 * max_ps16;
	s32 *ps32;
	int fail_node;
	struct hideep_data *ts   = private_ts;
	struct hideep_debug_dev *dev = &ts->debug_dev;
	DWZ_INFO_T  *dmz_info = &ts->dwz_info;
	u8 *str_buf;
	u8 *str_mms_buf;
	int min,max,sum,i,j;
	u16 vr_buff;
	
	
	disable_irq(ts->client->irq);
	dbg_fun("hideep_get_rawdata enter");
	str_buf = NULL;
	str_mms_buf = NULL;
	dmz_info->pannel.rx = HIDEEP_RX_COUNT;
	dmz_info->pannel.tx = HIDEEP_TX_COUNT;
	info->buff[0] = dmz_info->pannel.rx;
	info->buff[1] = dmz_info->pannel.tx;
	info->used_size = info->buff[0]*info->buff[1]*2+2;
	dev->im_size = info->buff[0]*info->buff[1]*2+8;
	dev->im_buff = kmalloc(dev->im_size, GFP_KERNEL);
	if(dev->im_buff == NULL){
		dbg_err("can't alloc memory");
		goto hideep_get_rawdata_alloc_err;
	}
	str_buf = kmalloc(1024, GFP_KERNEL);
	if(str_buf == NULL){
		dbg_err("can't alloc memory");
		goto hideep_get_rawdata_alloc_err;
	}
	str_mms_buf = kmalloc(1024, GFP_KERNEL);
	if(str_mms_buf == NULL){
		dbg_err("can't alloc memory");
		goto hideep_get_rawdata_alloc_err;
	}
	memset(str_buf,0,1024);
	memset(str_mms_buf,0,1024);
	dbg_fun("hideep_get_rawdata t = %d, r = %d",info->buff[1],info->buff[0]);
	mutex_lock(&ts->io_lock);
	dev->im_r_en = 1;

	dbg_fun("x,y rawdata enter");
	//reading x,y rawdata....
	mdelay(300);
	//ret = hideep_get_image_by_cmd(0,OPM_DEMOD);
	ret = hideep_get_image_by_cmd(0x0804,3);
	if(ret != 0) {
		memcpy(str_buf,"0F-1F-2F-3F-4F\n",strlen("0F-1F-2F-3F-4F")+1);
		goto hideep_get_rawdata_rd_err;
	}else{
		memcpy(str_buf,"0P",strlen("0P"));
	}
	//checking x,y rawdata.
	calculate_data_init(2,rawdata_min,rawdata_max);
	for(i = 0;i<HIDEEP_TX_COUNT;i++){
		#ifdef HIDEEP_DEBUG_RAWDATA_LOG
		printk("TX = %02d  ",i);
		for(j = 0;j<HIDEEP_RX_COUNT;j++){
			printk("%4d,",*(ps16+j));
		}
		printk("\n");
		#endif
		//HIDEEP_RX_COUNT-1 the last one is for saving Z.
		ps32 = info->buff + 2 + i*HIDEEP_RX_COUNT;
		for(j = 0;j<HIDEEP_RX_COUNT;j++){
			calculate_data_result(ps32,ps16,min,max,sum);
		}
	}
	dbg_fun("fail_node = %d",fail_node);
	if(fail_node){
		strncat(str_buf, "-1F", MAX_STR_LEN);
	}else{
		strncat(str_buf, "-1P", MAX_STR_LEN);
	}
	i=strlen(str_mms_buf);
	snprintf(str_mms_buf+i,1024-i,"[%4d,%4d,%4d] ",sum/(HIDEEP_TX_COUNT*HIDEEP_RX_COUNT),max,min);

	dbg_fun("x,y diff enter");
	//reading x,y diff....
	ret = hideep_get_image_by_cmd(0,OPM_DIFF_CAP);
	if(ret != 0) {
		memcpy(str_buf,"0F-1F-2F-3F-4F\n",strlen("0F-1F-2F-3F-4F")+1);
		goto hideep_get_rawdata_rd_err;
	}
	//checking x,y diff.
	calculate_data_init(2+HIDEEP_TX_COUNT*HIDEEP_RX_COUNT,diffdata_min,diffdata_max);
	for(i = 0;i<HIDEEP_TX_COUNT;i++){
		#ifdef HIDEEP_DEBUG_RAWDATA_LOG
		printk("RX = %02d  ",i);
		for(j = 0;j<HIDEEP_RX_COUNT;j++){
			printk("%4d,",*(ps16+j));
		}
		printk("\n");
		#endif
		//HIDEEP_RX_COUNT-1 the last one is for saving Z.
		ps32 = info->buff+2+HIDEEP_TX_COUNT*HIDEEP_RX_COUNT + i*HIDEEP_RX_COUNT;
		for(j = 0;j<HIDEEP_RX_COUNT;j++){
			calculate_data_result(ps32,ps16,min,max,sum);
		}
	}
	dbg_fun("fail_node = %d",fail_node);
	if(fail_node){
		strncat(str_buf, "-2F", MAX_STR_LEN);
	}else{
		strncat(str_buf, "-2P", MAX_STR_LEN);
	}
	i=strlen(str_mms_buf);
	snprintf(str_mms_buf+i,1024-i,"[%4d,%4d,%4d] ",sum/(HIDEEP_TX_COUNT*HIDEEP_RX_COUNT),max,min);

	memcpy(info->result,str_buf,strlen(str_buf)+1);
	i=strlen(info->result);
	memcpy(info->result+i,str_mms_buf,strlen(str_mms_buf)+1);
	printk("%s\n",info->result);
	dbg_fun("finished.");
	ret = 0;
hideep_get_rawdata_rd_err:
	dev->i_rdy = 0;
	vr_buff = OPM_TOUCH_A;
	ret = hideep_i2c_write(ts->client, 0, 1,(u8*)&vr_buff);
	dev->im_r_en = 0;
	mutex_unlock(&ts->io_lock);
hideep_get_rawdata_alloc_err:
	enable_irq(ts->client->irq);
	if(dev->im_buff)
		kfree(dev->im_buff);
	if(str_buf)
		kfree(str_buf);
	if(str_mms_buf)
		kfree(str_mms_buf);
	ts->pdata->reset();
	mdelay(50);
	return ret;
}




static int rawdata_proc_show(struct seq_file *m, void *v)
{
	int index;
	int index1;
	short row_size = 0;
	int range_size = 0;
	int error = 0;
	struct rawdata_info *info = NULL;

	dbg_fun("rawdata_proc_show, buffer size = %ld", (long)m->size);
	if(m->size <= RAW_DATA_SIZE) {
		m->count = m->size;
		return 0;
	}

	info = (struct rawdata_info *)kzalloc(sizeof(struct rawdata_info), GFP_KERNEL);
	if (!info) {
		dbg_err("malloc failed");
		error = -ENOMEM;
		goto out;
	}

	info->used_size = 0;
	error = hideep_get_rawdata(info);
	if (error) {
		dbg_err("can't get rawdata %d", error);
		error = -EBUSY;
		goto out;
	}

	//seq_printf(m, "result:%s\n", info->result);

	row_size = info->buff[0];
	range_size = info->buff[1];
	seq_printf(m, "rx: %d, tx : %d\n", row_size, range_size);

	for (index=0; row_size*index+2 < info->used_size; index++) {
		if (0 == index) {
			seq_printf(m, "rawdata:\n");							/*print the title*/
		}
		for (index1=0; index1 < row_size; index1++) {
			seq_printf(m, "%4d,", info->buff[2+row_size*index+index1]);		/*print oneline*/
		}
		//index1 = 0;
		seq_printf(m, "\n ");

		if ((range_size -1) == index) {
			seq_printf(m, "diff:\n");
		}
	}
	error = 0;

out:
	if (info)
		kfree(info);
	dbg_fun("done");
	return error;
}

static int rawdata_proc_open(struct inode *inode, struct file *file)
{
	return single_open(file, rawdata_proc_show, NULL);
}

static const struct file_operations rawdata_proc_fops = {
	.open		= rawdata_proc_open,
	.read		= seq_read,
	.llseek		= seq_lseek,
	.release	= single_release,
};

void procfs_create(void)
{
	//dbg_err("enter");
	//if (!proc_mkdir("", NULL))
	//	return;
	//dbg_err("enter2");
	proc_create("rawdata", S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH, NULL, &rawdata_proc_fops);
	//dbg_err("enter3");
	return;
}
